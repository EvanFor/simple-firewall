<!DOCTYPE html>

<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <title>NetWall åŠ¨æ€é˜²ç«å¢™ (åœ°ç†ä½ç½®ç‰ˆ)</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                background: #f3f4f6;
                margin: 0;
                padding: 20px;
                color: #333;
            }

            .container {
                max-width: 1500px;
                margin: 0 auto;
            }

            .card {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                padding: 20px;
                margin-bottom: 20px;
            }

            h1 {
                margin-top: 0;
                color: #1f2937;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            h2 {
                font-size: 1.1rem;
                color: #4b5563;
                margin-bottom: 15px;
                border-left: 4px solid #2563eb;
                padding-left: 10px;
            }

            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }

            .control {
                background: #f9fafb;
                padding: 15px;
                border-radius: 6px;
                border: 1px solid #e5e7eb;
            }

            .control label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                font-size: 0.9rem;
                color: #374151;
            }

            .chk-group {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .chk-group label {
                font-weight: normal;
                background: white;
                border: 1px solid #d1d5db;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.85rem;
                user-select: none;
                transition: all 0.2s;
            }

            .chk-group label:hover {
                border-color: #2563eb;
            }

            .chk-group input:checked + span {
                color: #2563eb;
                font-weight: 600;
            }

            select, textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                box-sizing: border-box;
                font-family: inherit;
                background: white;
            }

            textarea {
                height: 80px;
                resize: vertical;
            }

            button {
                background: #2563eb;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                width: 100%;
                margin-top: 10px;
                transition: background 0.2s;
            }

            button:hover {
                background: #1d4ed8;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.85rem;
            }

            th {
                text-align: left;
                padding: 12px 10px;
                background: #f9fafb;
                border-bottom: 2px solid #e5e7eb;
                position: sticky;
                top: 0;
                color: #6b7280;
                font-weight: 600;
                white-space: nowrap;
            }

            td {
                padding: 8px 10px;
                border-bottom: 1px solid #e5e7eb;
                font-family: monospace;
                color: #1f2937;
            }

            tr:hover {
                background: #f9fafb;
            }

            .badge {
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .p-http {
                background: #dbeafe;
                color: #1e40af;
            }

            .p-https {
                background: #dbeafe;
                color: #1e40af;
            }

            .p-dns {
                background: #d1fae5;
                color: #065f46;
            }

            .p-tcp {
                background: #ffedd5;
                color: #9a3412;
            }

            .p-udp {
                background: #f3e8ff;
                color: #6b21a8;
            }

            .dir-out {
                color: #dc2626;
                font-weight: 600;
            }

            .dir-in {
                color: #16a34a;
                font-weight: 600;
            }

            #msg {
                margin-top: 10px;
                color: #16a34a;
                text-align: center;
                display: none;
                font-weight: 500;
                background: #dcfce7;
                padding: 8px;
                border-radius: 4px;
            }

            .tip {
                font-size: 0.85rem;
                color: #6b7280;
                margin-top: 5px;
                line-height: 1.5;
            }

            .tip code {
                background: #e5e7eb;
                padding: 2px 4px;
                border-radius: 3px;
                font-family: monospace;
            }

            /* åœ°ç†ä½ç½®åˆ—æ ·å¼ */
            .loc-cell {
                white-space: nowrap;
                max-width: 180px;
                overflow: hidden;
                text-overflow: ellipsis;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ğŸ›¡ï¸ NetWall åŠ¨æ€é˜²ç«å¢™ </h1>

            <div class="card">
                <h2>âš™ï¸ å®æ—¶è¿‡æ»¤è§„åˆ™é…ç½®</h2>
                <div class="grid">
                    <div class="control">
                        <label>å…è®¸çš„åè®® (å–æ¶ˆå‹¾é€‰å³è¿‡æ»¤)</label>
                        <div class="chk-group" id="proto-list">
                            <label><input type="checkbox" value="HTTP" checked> <span>HTTP</span></label>
                            <label><input type="checkbox" value="HTTPS" checked> <span>HTTPS</span></label>
                            <label><input type="checkbox" value="DNS"> <span>DNS</span></label>
                            <label><input type="checkbox" value="TCP"> <span>TCP</span></label>
                            <label><input type="checkbox" value="UDP"> <span>UDP</span></label>
                            <label><input type="checkbox" value="QUIC"> <span>QUIC</span></label>
                        </div>
                        <div class="tip">ğŸ’¡ é»˜è®¤ä»…ç›‘æ§ HTTP/HTTPSã€‚å¦‚éœ€ç›‘æ§åº•å±‚æµé‡ï¼Œè¯·å‹¾é€‰å¯¹åº”åè®®ã€‚</div>
                    </div>
                    <div class="control">
                        <label>æµé‡æ–¹å‘</label>
                        <select id="direction-select">
                            <option value="ALL">å…¨éƒ¨æ–¹å‘</option>
                            <option value="OUT">ä»…å‡ºç«™</option>
                            <option value="IN">ä»…å…¥ç«™</option>
                        </select>
                    </div>
                    <div class="control">
                        <label><input type="checkbox" id="enable-domain-block"> å¯ç”¨åŸŸåé»‘åå•</label>
                        <textarea id="blocked-domains" placeholder="æ¯è¡Œä¸€ä¸ªåŸŸå..."></textarea>
                        <button onclick="saveConfig()">åº”ç”¨æ›´æ”¹</button>
                        <div id="msg">âœ… è§„åˆ™å·²å®æ—¶æ›´æ–°ï¼</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>ğŸ“¡ å®æ—¶æµé‡ç›‘æ§</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>æ–¹å‘</th>
                            <th>åè®®</th>
                            <th>æº IP</th>
                            <th>ç›®æ ‡ IP</th>
                            <th>ğŸŒ åœ°ç†ä½ç½®</th>
                            <th>ä¸»æœº / è¯¦æƒ…</th>
                            <th>å¤§å°</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                        </thead>
                        <tbody id="log-body"></tbody>
                    </table>
                </div>
                <div id="empty-tip" style="text-align:center; color:#9ca3af; padding: 20px; display:none;">
                    æš‚æ— æµé‡æ•°æ®ã€‚è¯·é…ç½®æµè§ˆå™¨ä»£ç†åˆ° <code>127.0.0.1:8080</code>ã€‚
                </div>
            </div>
        </div>

        <script>
            const tbody = document.getElementById('log-body');
            const msgDiv = document.getElementById('msg');
            const emptyTip = document.getElementById('empty-tip');

            // ç®€å•çš„å›½æ——æ˜ å°„
            function getFlag(location) {
                if (!location) return "";
                if (location.includes("ä¸­å›½")) return "ğŸ‡¨ğŸ‡³ ";
                if (location.includes("ç¾å›½")) return "ğŸ‡ºğŸ‡¸ ";
                if (location.includes("æ—¥æœ¬")) return "ğŸ‡¯ğŸ‡µ ";
                if (location.includes("éŸ©å›½")) return "ğŸ‡°ğŸ‡· ";
                if (location.includes("å¾·å›½")) return "ğŸ‡©ğŸ‡ª ";
                if (location.includes("è‹±å›½")) return "ğŸ‡¬ğŸ‡§ ";
                if (location.includes("æ³•å›½")) return "ğŸ‡«ğŸ‡· ";
                if (location.includes("ä¿„ç½—æ–¯")) return "ğŸ‡·ğŸ‡º ";
                if (location.includes("å±€åŸŸç½‘") || location.includes("æœ¬åœ°")) return "ğŸ  ";
                return "ğŸŒ ";
            }

            async function loadConfig() {
                try {
                    const res = await fetch('/api/config');
                    const cfg = await res.json();
                    document.querySelectorAll('#proto-list input').forEach(cb => {
                        cb.checked = cfg.enabled_protocols.includes(cb.value);
                    });
                    document.getElementById('direction-select').value = cfg.filter_direction || 'ALL';
                    document.getElementById('enable-domain-block').checked = cfg.enable_domain_block || false;
                    document.getElementById('blocked-domains').value = (cfg.blocked_domains || []).join('\n');
                } catch (err) {
                    console.error(err);
                }
            }

            window.saveConfig = function () {
                const protocols = Array.from(document.querySelectorAll('#proto-list input:checked')).map(cb => cb.value);
                const payload = {
                    enabled_protocols: protocols,
                    filter_direction: document.getElementById('direction-select').value,
                    enable_domain_block: document.getElementById('enable-domain-block').checked,
                    blocked_domains: document.getElementById('blocked-domains').value.split('\n').filter(x => x.trim())
                };
                fetch('/api/config', {method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload)})
                    .then(() => {
                        msgDiv.style.display = 'block';
                        setTimeout(() => msgDiv.style.display = 'none', 2000);
                    });
            };

            function connectWS() {
                const ws = new WebSocket(`ws://${window.location.host}/ws`);
                ws.onopen = () => console.log('âœ… è¿æ¥æˆåŠŸ');
                ws.onclose = () => setTimeout(connectWS, 2000);
                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'new_packet') {
                            const d = msg.data;
                            const row = document.createElement('tr');

                            let pClass = 'p-tcp';
                            if (['HTTP', 'HTTPS'].includes(d.protocol)) pClass = 'p-https';
                            else if (d.protocol === 'DNS') pClass = 'p-dns';
                            else if (d.protocol === 'UDP') pClass = 'p-udp';

                            const dirClass = d.direction === 'OUT' ? 'dir-out' : 'dir-in';
                            if (emptyTip) emptyTip.style.display = 'none';

                            const flag = getFlag(d.location);
                            const locText = d.location || '-';

                            row.innerHTML = `
                                    <td>${d.timestamp}</td>
                                    <td class="${dirClass}">${d.direction === 'OUT' ? 'å‡ºç«™' : 'å…¥ç«™'}</td>
                                    <td><span class="badge ${pClass}">${d.protocol}</span></td>
                                    <td>${d.src_ip}</td>
                                    <td>${d.dst_ip}:${d.dst_port}</td>
                                    <td class="loc-cell" title="${locText}">${flag}${locText}</td>
                                    <td style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${d.host || d.info}">${d.host || d.info}</td>
                                    <td>${(d.size / 1024).toFixed(1)} KB</td>
                                    <td>${d.method || d.status}</td>
                                `;
                            tbody.insertBefore(row, tbody.firstChild);
                            if (tbody.children.length > 100) tbody.removeChild(tbody.lastChild);
                        }
                    } catch (e) {
                        console.error(e);
                    }
                };
            }

            loadConfig();
            connectWS();
            setTimeout(() => {
                if (tbody.children.length === 0 && emptyTip) emptyTip.style.display = 'block';
            }, 1000);
        </script>
    </body>
</html>