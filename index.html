<!DOCTYPE html>

<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <title>NetWall Èò≤ÁÅ´Â¢ô (Âê´ÂÜÖÂÆπÊü•Áúã)</title>
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                background: #f3f4f6;
                margin: 0;
                padding: 20px;
                color: #333;
            }

            .container {
                max-width: 1600px;
                margin: 0 auto;
            }

            .card {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                padding: 20px;
                margin-bottom: 20px;
            }

            h1 {
                margin-top: 0;
                color: #1f2937;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            h2 {
                font-size: 1.1rem;
                color: #4b5563;
                margin-bottom: 15px;
                border-left: 4px solid #2563eb;
                padding-left: 10px;
            }

            .grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px;
            }

            .control {
                background: #f9fafb;
                padding: 15px;
                border-radius: 6px;
                border: 1px solid #e5e7eb;
            }

            .control label {
                display: block;
                font-weight: 600;
                margin-bottom: 8px;
                font-size: 0.9rem;
            }

            .chk-group {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
            }

            .chk-group label {
                font-weight: normal;
                background: white;
                border: 1px solid #d1d5db;
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.85rem;
                user-select: none;
            }

            .chk-group input:checked + span {
                color: #2563eb;
                font-weight: 600;
            }

            select, textarea {
                width: 100%;
                padding: 8px;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                box-sizing: border-box;
            }

            textarea {
                height: 80px;
                resize: vertical;
            }

            button {
                background: #2563eb;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: 500;
                width: 100%;
                margin-top: 10px;
            }

            button:hover {
                background: #1d4ed8;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.85rem;
            }

            th {
                text-align: left;
                padding: 12px 10px;
                background: #f9fafb;
                border-bottom: 2px solid #e5e7eb;
                position: sticky;
                top: 0;
                color: #6b7280;
                font-weight: 600;
                white-space: nowrap;
            }

            td {
                padding: 8px 10px;
                border-bottom: 1px solid #e5e7eb;
                font-family: monospace;
                color: #1f2937;
            }

            tr:hover {
                background: #f9fafb;
            }

            .badge {
                padding: 2px 8px;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 600;
                text-transform: uppercase;
            }

            .p-http {
                background: #dbeafe;
                color: #1e40af;
            }

            .p-https {
                background: #dbeafe;
                color: #1e40af;
            }

            .p-dns {
                background: #d1fae5;
                color: #065f46;
            }

            .p-tcp {
                background: #ffedd5;
                color: #9a3412;
            }

            .dir-out {
                color: #dc2626;
                font-weight: 600;
            }

            .dir-in {
                color: #16a34a;
                font-weight: 600;
            }

            #msg {
                margin-top: 10px;
                color: #16a34a;
                text-align: center;
                display: none;
                background: #dcfce7;
                padding: 8px;
                border-radius: 4px;
            }

            /* ËØ¶ÊÉÖÊåâÈíÆ */
            .btn-view {
                background: #10b981;
                padding: 4px 8px;
                font-size: 0.75rem;
                width: auto;
                margin: 0;
            }

            .btn-view:hover {
                background: #059669;
            }

            /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
            .modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: auto;
                background-color: rgba(0, 0, 0, 0.5);
            }

            .modal-content {
                background-color: #fefefe;
                margin: 5% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
                max-width: 1000px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            }

            .close {
                color: #aaa;
                float: right;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
            }

            .close:hover {
                color: black;
            }

            .modal-header {
                border-bottom: 1px solid #eee;
                padding-bottom: 10px;
                margin-bottom: 15px;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .modal-body {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .content-box {
                background: #f8f9fa;
                padding: 10px;
                border-radius: 4px;
                border: 1px solid #e9ecef;
                max-height: 60vh;
                overflow-y: auto;
            }

            .content-box h3 {
                margin-top: 0;
                font-size: 1rem;
                color: #495057;
                border-bottom: 2px solid #dee2e6;
                padding-bottom: 5px;
            }

            pre {
                white-space: pre-wrap;
                word-wrap: break-word;
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 0.85rem;
                color: #333;
                margin: 0;
            }

            @media (max-width: 768px) {
                .modal-body {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üõ°Ô∏è NetWall Èò≤ÁÅ´Â¢ô </h1>

            <div class="card">
                <h2>‚öôÔ∏è ËøáÊª§ËßÑÂàô</h2>
                <div class="grid">
                    <div class="control">
                        <label>ÂÖÅËÆ∏ÂçèËÆÆ</label>
                        <div class="chk-group" id="proto-list">
                            <label><input type="checkbox" value="HTTP" checked> <span>HTTP</span></label>
                            <label><input type="checkbox" value="HTTPS" checked> <span>HTTPS</span></label>
                            <label><input type="checkbox" value="DNS"> <span>DNS</span></label>
                            <label><input type="checkbox" value="TCP"> <span>TCP</span></label>
                            <label><input type="checkbox" value="UDP"> <span>UDP</span></label>
                        </div>
                    </div>
                    <div class="control">
                        <label>ÊñπÂêë</label>
                        <select id="direction-select">
                            <option value="ALL">ÂÖ®ÈÉ®</option>
                            <option value="OUT">‰ªÖÂá∫Á´ô</option>
                            <option value="IN">‰ªÖÂÖ•Á´ô</option>
                        </select>
                    </div>
                    <div class="control">
                        <label><input type="checkbox" id="enable-domain-block"> ÂüüÂêçÈªëÂêçÂçï</label>
                        <textarea id="blocked-domains" placeholder="example.com"></textarea>
                        <button onclick="saveConfig()">Â∫îÁî®</button>
                        <div id="msg">‚úÖ Â∑≤Êõ¥Êñ∞</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üì° ÂÆûÊó∂ÊµÅÈáè </h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                        <tr>
                            <th>Êó∂Èó¥</th>
                            <th>ÊñπÂêë</th>
                            <th>ÂçèËÆÆ</th>
                            <th>Ê∫ê IP</th>
                            <th>ÁõÆÊ†á IP</th>
                            <th>Âú∞ÁêÜ‰ΩçÁΩÆ</th>
                            <th>‰∏ªÊú∫ / Ë∑ØÂæÑ</th>
                            <th>Â§ßÂ∞è</th>
                            <th>Áä∂ÊÄÅ</th>
                            <th>Êìç‰Ωú</th>
                        </tr>
                        </thead>
                        <tbody id="log-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">ËØ∑Ê±ÇËØ¶ÊÉÖ</h2>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="content-box">
                        <h3>üì§ ËØ∑Ê±Ç (Request)</h3>
                        <div id="reqInfo" style="margin-bottom:10px; font-size:0.85rem; color:#666;"></div>
                        <pre id="reqBody">Êó†Êï∞ÊçÆ</pre>
                    </div>
                    <div class="content-box">
                        <h3>üì• ÂìçÂ∫î (Response)</h3>
                        <div id="resInfo" style="margin-bottom:10px; font-size:0.85rem; color:#666;"></div>
                        <pre id="resBody">Êó†Êï∞ÊçÆ</pre>
                    </div>
                </div>
            </div>
        </div>

        <script>
            const tbody = document.getElementById('log-body');
            const modal = document.getElementById('detailModal');
            const rowMap = new Map();
            const dataCache = new Map();

            async function loadConfig() {
                try {
                    const res = await fetch('/api/config');
                    const cfg = await res.json();
                    document.querySelectorAll('#proto-list input').forEach(cb => cb.checked = cfg.enabled_protocols.includes(cb.value));
                    document.getElementById('direction-select').value = cfg.filter_direction || 'ALL';
                    document.getElementById('enable-domain-block').checked = cfg.enable_domain_block || false;
                    document.getElementById('blocked-domains').value = (cfg.blocked_domains || []).join('\n');
                } catch(e){}
            }

            window.saveConfig = function() {
                const payload = {
                    enabled_protocols: Array.from(document.querySelectorAll('#proto-list input:checked')).map(cb => cb.value),
                    filter_direction: document.getElementById('direction-select').value,
                    enable_domain_block: document.getElementById('enable-domain-block').checked,
                    blocked_domains: document.getElementById('blocked-domains').value.split('\n').filter(x => x.trim())
                };
                fetch('/api/config', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
                    .then(() => { const m = document.getElementById('msg'); m.style.display='block'; setTimeout(()=>m.style.display='none', 2000); });
            };

            function getFlag(loc) {
                if(!loc) return "";
                if(loc.includes("‰∏≠ÂõΩ")) return "üá®üá≥ "; if(loc.includes("ÁæéÂõΩ")) return "üá∫üá∏ ";
                if(loc.includes("Êó•Êú¨")) return "üáØüáµ "; if(loc.includes("Â±ÄÂüüÁΩë")) return "üè† ";
                return "üåç ";
            }

            function formatJSON(str) {
                if(!str) return "";
                // Â¶ÇÊûúÊòØ‰∫åËøõÂà∂ÊèêÁ§∫ÔºåÁõ¥Êé•ËøîÂõû
                if(str.startsWith('[') && str.endsWith(']')) return str;
                try { return JSON.stringify(JSON.parse(str), null, 2); } catch (e) { return str; }
            }

            function openModalById(id) {
                const d = dataCache.get(id);
                if(!d) { alert("Êï∞ÊçÆÂ∑≤Ê∏ÖÁêÜ"); return; }

                document.getElementById('modalTitle').innerText = `ËØ¶ÊÉÖÔºö${d.method} ${d.host}`;

                // Ê∏≤ÊüìËØ∑Ê±Ç
                document.getElementById('reqInfo').textContent = `${d.method} ${d.path || ''}\nHost: ${d.host}`;
                // Â¶ÇÊûúÊúâ req_body ÂàôÊòæÁ§∫ÔºåÂê¶ÂàôÊèêÁ§∫
                const rBody = d.req_body || (d.direction === 'OUT' ? "(Êó†ËØ∑Ê±Ç‰Ωì)" : "(ÂΩìÂâçÊòØÂìçÂ∫îÂåÖÔºåËØ∑Ê±Ç‰ΩìÂèØËÉΩÂú®‰∏ä‰∏ÄÊù°ËÆ∞ÂΩï‰∏≠)");
                document.getElementById('reqBody').textContent = formatJSON(rBody);

                // Ê∏≤ÊüìÂìçÂ∫î
                document.getElementById('resInfo').textContent = `Status: ${d.status || 'Unknown'}`;
                let resText = "(Êó†ÂìçÂ∫î‰Ωì)";
                if (d.res_body) {
                    resText = formatJSON(d.res_body);
                } else if (d.status === 'Pending') {
                    resText = "(Á≠âÂæÖÂìçÂ∫î...)";
                } else if (d.status) {
                    resText = `(ÂìçÂ∫îÁä∂ÊÄÅ ${d.status}, ‰ΩÜÊó†ÂÜÖÂÆπ‰ΩìÔºåÂèØËÉΩÊòØ 204/304 ÊàñÂõæÁâá/ËßÜÈ¢ëÊµÅ)`;
                }
                document.getElementById('resBody').textContent = resText;

                modal.style.display = "block";
            }

            function closeModal() { modal.style.display = "none"; }
            window.onclick = function(event) { if (event.target === modal) closeModal(); }

            function renderRow(d) {
                let row = rowMap.get(d.id);
                let isNew = false;

                if (!row) {
                    row = document.createElement('tr');
                    row.id = `row-${d.id}`;
                    tbody.insertBefore(row, tbody.firstChild);
                    rowMap.set(d.id, row);
                    isNew = true;

                    if (tbody.children.length > 100) {
                        const lastRow = tbody.lastChild;
                        if(lastRow && lastRow.id) {
                            const oldId = lastRow.id.replace('row-', '');
                            rowMap.delete(oldId);
                            dataCache.delete(oldId);
                        }
                        tbody.removeChild(lastRow);
                    }
                } else {
                    row.classList.remove('updated');
                    void row.offsetWidth;
                    row.classList.add('updated');
                }

                dataCache.set(d.id, d);

                let pClass = ['HTTP','HTTPS'].includes(d.protocol) ? 'p-https' : 'p-tcp';
                if(d.protocol === 'DNS') pClass = 'p-dns';
                const dirClass = d.direction === 'OUT' ? 'dir-out' : 'dir-in';
                const flag = getFlag(d.location);
                const urlDisplay = d.host + (d.path || '');

                const isFinished = d.status !== 'Pending' && d.status !== undefined && d.status !== null;

                const statusDisplay = isFinished ? d.status : (d.method || '‚è≥ Á≠âÂæÖ...');
                const statusColor = isFinished ? '#16a34a' : '#d97706';

                let viewBtn = '';
                if(['HTTP','HTTPS'].includes(d.protocol)) {
                    if(isFinished) {
                        // Âè™Ë¶ÅÊúâÁä∂ÊÄÅÁ†ÅÔºåÂ∞±ÊòæÁ§∫Êü•ÁúãÊåâÈíÆ
                        viewBtn = `<button class="btn-view ready" onclick='openModalById(${d.id})'>üëÅÔ∏è Êü•Áúã</button>`;
                    } else {
                        viewBtn = `<span style="color:#999;font-size:0.75rem;">‚è≥ Ëß£Êûê‰∏≠...</span>`;
                    }
                }

                row.innerHTML = `
                <td>${d.timestamp}</td>
                <td class="${dirClass}">${d.direction === 'OUT' ? 'Âá∫Á´ô' : 'ÂÖ•Á´ô'}</td>
                <td><span class="badge ${pClass}">${d.protocol}</span></td>
                <td>${d.src_ip}</td>
                <td>${d.dst_ip}:${d.dst_port}</td>
                <td style="font-size:0.85rem;">${flag}${d.location || '-'}</td>
                <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${urlDisplay}">${urlDisplay}</td>
                <td>${(d.size/1024).toFixed(1)} KB</td>
                <td style="font-weight:bold; color:${statusColor}">${statusDisplay}</td>
                <td>${viewBtn}</td>
            `;
            }

            function connectWS() {
                const ws = new WebSocket(`ws://${window.location.host}/ws`);
                ws.onopen = () => console.log('‚úÖ WebSocket Â∑≤ËøûÊé•');
                ws.onclose = () => setTimeout(connectWS, 2000);
                ws.onmessage = (event) => {
                    try {
                        const msg = JSON.parse(event.data);
                        if (msg.type === 'new_packet') {
                            renderRow(msg.data);
                        }
                    } catch (e) { console.error(e); }
                };
            }

            loadConfig();
            connectWS();
        </script>
    </body>
</html>